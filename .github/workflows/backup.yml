name: DaVinci Database Backup

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹æ‰§è¡Œï¼ˆUTC 2ç‚¹ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup PostgreSQL client
      run: |
        # å°è¯•å®‰è£… PostgreSQL 17ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨ Docker
        if ! (sudo apt-get update && sudo apt-get install -y wget ca-certificates && \
              wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && \
              echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list && \
              sudo apt-get update && sudo apt-get install -y postgresql-client-17); then
          echo "PostgreSQL 17 å®‰è£…å¤±è´¥ï¼Œä½¿ç”¨ Docker æ–¹æ¡ˆ"
          sudo apt-get install -y postgresql-client
        fi
        
        # éªŒè¯ç‰ˆæœ¬
        pg_dump --version || echo "å°†ä½¿ç”¨ Docker å¤‡ä»½"
        
    - name: Create backup
      env:
        SUPABASE_HOST: ${{ secrets.SUPABASE_HOST }}
        SUPABASE_USER: ${{ secrets.SUPABASE_USER }}
        SUPABASE_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
      run: |
        DATE=$(date +"%Y%m%d_%H%M%S")
        BACKUP_FILE="davinci_backup_$DATE.sql"
        
        echo "ğŸ”„ å¼€å§‹å¤‡ä»½è¾¾èŠ¬å¥‡æ•°æ®åº“..."
        
        # åˆ›å»ºå¤‡ä»½ - ä½¿ç”¨ Docker ç¡®ä¿ç‰ˆæœ¬å…¼å®¹
        if command -v pg_dump >/dev/null 2>&1 && pg_dump --version | grep -q "17\."; then
          echo "ä½¿ç”¨æœ¬åœ° PostgreSQL 17 å®¢æˆ·ç«¯"
          PGPASSWORD="$SUPABASE_PASSWORD" pg_dump \
            -h "$SUPABASE_HOST" \
            -p 6543 \
            -U "$SUPABASE_USER" \
            -d postgres \
            -f "$BACKUP_FILE" \
            --no-sync \
            --verbose
        else
          echo "ä½¿ç”¨ Docker PostgreSQL 17 å®¢æˆ·ç«¯"
          docker run --rm \
            -e PGPASSWORD="$SUPABASE_PASSWORD" \
            -v $(pwd):/backup \
            postgres:17 \
            pg_dump \
            -h "$SUPABASE_HOST" \
            -p 6543 \
            -U "$SUPABASE_USER" \
            -d postgres \
            -f "/backup/$BACKUP_FILE" \
            --no-sync \
            --verbose
        fi
          
        # å‹ç¼©å¤‡ä»½
        gzip "$BACKUP_FILE"
        
        # æ˜¾ç¤ºå¤‡ä»½ä¿¡æ¯
        BACKUP_SIZE=$(du -h "${BACKUP_FILE}.gz" | cut -f1)
        echo "âœ… å¤‡ä»½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $BACKUP_SIZE"
        
        echo "BACKUP_FILE=${BACKUP_FILE}.gz" >> $GITHUB_ENV
        
    - name: Upload backup to GitHub Releases
      uses: softprops/action-gh-release@v1
      with:
        tag_name: backup-$(date +"%Y%m%d")
        files: ${{ env.BACKUP_FILE }}
        name: "æ•°æ®åº“å¤‡ä»½ $(date +'%Yå¹´%mæœˆ%dæ—¥')"
        body: |
          ğŸ—„ï¸ è¾¾èŠ¬å¥‡æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½
          
          ğŸ“… å¤‡ä»½æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S UTC')
          ğŸ“Š å¤‡ä»½æ–‡ä»¶: ${{ env.BACKUP_FILE }}
          
          ## æ¢å¤æ–¹æ³•
          1. ä¸‹è½½å¤‡ä»½æ–‡ä»¶
          2. è§£å‹: `gunzip ${{ env.BACKUP_FILE }}`
          3. æ¢å¤: `psql -h host -U user -d postgres < backup.sql`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Clean old releases (keep last 30)
      uses: dev-drprasad/delete-older-releases@v0.3.2
      with:
        keep_latest: 30
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
