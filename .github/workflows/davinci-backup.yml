name: DaVinci Database Docker Backup

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹æ‰§è¡Œï¼ˆUTC 2ç‚¹ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  docker-backup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Pull PostgreSQL 17 Docker image
      run: |
        echo "ğŸ³ æ‹‰å– PostgreSQL 17 Docker é•œåƒ..."
        docker pull postgres:17
        echo "âœ… PostgreSQL 17 é•œåƒå‡†å¤‡å®Œæˆ"
        
        # éªŒè¯ Docker é•œåƒä¸­çš„ pg_dump ç‰ˆæœ¬
        docker run --rm postgres:17 pg_dump --version
        
    - name: Create database backup using Docker
      env:
        SUPABASE_HOST: ${{ secrets.SUPABASE_HOST }}
        SUPABASE_USER: ${{ secrets.SUPABASE_USER }}
        SUPABASE_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
      run: |
        echo "ğŸ”„ å¼€å§‹ä½¿ç”¨ Docker å¤‡ä»½è¾¾èŠ¬å¥‡æ•°æ®åº“..."
        
        # ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å
        DATE=$(date +"%Y%m%d_%H%M%S")
        BACKUP_FILE="davinci_backup_$DATE.sql"
        
        echo "ğŸ“… å¤‡ä»½æ—¶é—´: $(date)"
        echo "ğŸ“ å¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"
        
        # ä½¿ç”¨ Docker PostgreSQL 17 åˆ›å»ºå¤‡ä»½
        docker run --rm \
          -e PGPASSWORD="$SUPABASE_PASSWORD" \
          -v $(pwd):/workspace \
          --workdir /workspace \
          postgres:17 \
          pg_dump \
          -h "$SUPABASE_HOST" \
          -p 6543 \
          -U "$SUPABASE_USER" \
          -d postgres \
          -f "$BACKUP_FILE" \
          --no-sync \
          --verbose
        
        # æ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸ
        if [ -f "$BACKUP_FILE" ]; then
          echo "âœ… å¤‡ä»½æ–‡ä»¶åˆ›å»ºæˆåŠŸ"
          
          # å‹ç¼©å¤‡ä»½æ–‡ä»¶
          gzip "$BACKUP_FILE"
          COMPRESSED_FILE="${BACKUP_FILE}.gz"
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          BACKUP_SIZE=$(du -h "$COMPRESSED_FILE" | cut -f1)
          echo "ğŸ“Š å‹ç¼©åæ–‡ä»¶å¤§å°: $BACKUP_SIZE"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "BACKUP_FILE=$COMPRESSED_FILE" >> $GITHUB_ENV
          echo "BACKUP_SIZE=$BACKUP_SIZE" >> $GITHUB_ENV
        else
          echo "âŒ å¤‡ä»½æ–‡ä»¶åˆ›å»ºå¤±è´¥"
          exit 1
        fi
        
    - name: Upload backup to GitHub Releases
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: backup-$(date +"%Y%m%d-%H%M%S")
        files: ${{ env.BACKUP_FILE }}
        name: "ğŸ—„ï¸ è¾¾èŠ¬å¥‡æ•°æ®åº“å¤‡ä»½ $(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')"
        body: |
          ## ğŸ—„ï¸ è¾¾èŠ¬å¥‡æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½
          
          ğŸ“… **å¤‡ä»½æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')  
          ğŸ“Š **å¤‡ä»½æ–‡ä»¶**: `${{ env.BACKUP_FILE }}`  
          ğŸ“ **æ–‡ä»¶å¤§å°**: ${{ env.BACKUP_SIZE }}  
          ğŸ³ **å¤‡ä»½æ–¹å¼**: Docker PostgreSQL 17  
          
          ## ğŸ“¥ æ¢å¤æ–¹æ³•
          
          ### 1. ä¸‹è½½å¹¶è§£å‹å¤‡ä»½æ–‡ä»¶
          ```bash
          # ä¸‹è½½å¤‡ä»½æ–‡ä»¶
          wget https://github.com/double2tea/davinci-backup/releases/download/backup-$(date +"%Y%m%d-%H%M%S")/${{ env.BACKUP_FILE }}
          
          # è§£å‹å¤‡ä»½æ–‡ä»¶
          gunzip ${{ env.BACKUP_FILE }}
          ```
          
          ### 2. æ¢å¤åˆ°æ•°æ®åº“
          ```bash
          # æ¢å¤åˆ° Supabase æ•°æ®åº“
          psql -h your-host -p 6543 -U your-user -d postgres < davinci_backup_*.sql
          ```
          
          ### 3. åœ¨è¾¾èŠ¬å¥‡ä¸­é‡æ–°è¿æ¥
          é‡æ–°å¯åŠ¨ DaVinci Resolve å¹¶è¿æ¥åˆ°æ•°æ®åº“å³å¯çœ‹åˆ°æ¢å¤çš„é¡¹ç›®ã€‚
          
          ---
          ğŸ¤– æ­¤å¤‡ä»½ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Clean old releases
      if: success()
      uses: dev-drprasad/delete-older-releases@v0.3.2
      with:
        keep_latest: 30
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Backup completion notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ å¤‡ä»½ä»»åŠ¡å®Œæˆï¼"
          echo "ğŸ“¦ å¤‡ä»½æ–‡ä»¶å·²ä¸Šä¼ åˆ° Releases"
          echo "ğŸ”— æŸ¥çœ‹å¤‡ä»½: https://github.com/double2tea/davinci-backup/releases"
        else
          echo "âŒ å¤‡ä»½ä»»åŠ¡å¤±è´¥"
          echo "ğŸ” è¯·æ£€æŸ¥æ—¥å¿—ä»¥äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi